---
phase: 03-history-and-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_history_functions.sql
  - app/history/page.tsx
  - app/layout.tsx
  - components/history/history-client.tsx
  - components/history/trend-chart.tsx
  - components/history/time-range-picker.tsx
  - components/history/room-selector.tsx
  - components/history/summary-stats.tsx
  - components/history/chart-tooltip.tsx
  - components/history/gap-tooltip.tsx
  - components/navigation.tsx
  - lib/queries/history.ts
  - lib/hooks/use-chart-zoom.ts
  - lib/hooks/use-persisted-state.ts
  - lib/types.ts
  - lib/constants.ts
autonomous: true
requirements: [HIST-01, HIST-02, HIST-03, HIST-04, HIST-05]

must_haves:
  truths:
    - "User can view smooth area charts for temperature, humidity, and pressure per room"
    - "User can switch between 24h, 7d, 30d, and custom date range presets"
    - "User can overlay multiple rooms on the same chart and toggle rooms on/off"
    - "User can scroll to zoom and drag to pan within the chart"
    - "Data gaps appear as dashed-line shaded bands with hover tooltip showing duration"
    - "Summary stats (min, max, average) appear below the chart for selected time range"
    - "Selected time range and room selection persist across page reloads via localStorage"
    - "Navigation header with Dashboard | History | Health links appears on all pages"
  artifacts:
    - path: "supabase/migrations/005_history_functions.sql"
      provides: "PostgreSQL functions for time-bucketed aggregation, gap detection, and summary stats"
      contains: "get_sensor_history"
    - path: "app/history/page.tsx"
      provides: "Server component fetching default 24h data"
      exports: ["default"]
    - path: "components/history/history-client.tsx"
      provides: "Client wrapper managing time range, metric, rooms, and tooltip mode state"
    - path: "components/history/trend-chart.tsx"
      provides: "Recharts AreaChart with gradient fills, gap ReferenceAreas, zoom/pan"
    - path: "components/history/time-range-picker.tsx"
      provides: "Pill buttons (24h|7d|30d|Custom) + calendar date picker popover"
    - path: "components/history/room-selector.tsx"
      provides: "Room toggle buttons for overlay selection"
    - path: "components/history/summary-stats.tsx"
      provides: "Min/max/avg stat cards below chart"
    - path: "lib/queries/history.ts"
      provides: "Supabase query wrappers for history RPC calls"
    - path: "lib/hooks/use-chart-zoom.ts"
      provides: "Custom zoom/pan hook with wheel and drag handlers"
    - path: "lib/hooks/use-persisted-state.ts"
      provides: "localStorage-backed React state hook"
  key_links:
    - from: "app/history/page.tsx"
      to: "lib/queries/history.ts"
      via: "Server-side initial data fetch"
      pattern: "fetchSensorHistory|fetchGaps"
    - from: "components/history/history-client.tsx"
      to: "lib/queries/history.ts"
      via: "Client-side refetch on time range change"
      pattern: "fetchSensorHistory|fetchGaps|fetchSummaryStats"
    - from: "components/history/trend-chart.tsx"
      to: "lib/hooks/use-chart-zoom.ts"
      via: "Zoom/pan state management"
      pattern: "useChartZoom"
    - from: "lib/queries/history.ts"
      to: "supabase/migrations/005_history_functions.sql"
      via: "Supabase RPC calls to database functions"
      pattern: "supabase\\.rpc\\('get_sensor_history'|'detect_gaps'"
---

<objective>
Historical trend charts with time range selection, room comparison, data gap visualization, summary stats, and app-wide navigation.

Purpose: Users can explore how indoor conditions have changed over time across rooms, with smooth Apple Health-style area charts that support zoom/pan interaction and clearly show data gaps.

Output: History page at /history with Recharts AreaChart, time range picker (24h|7d|30d|Custom), room toggle selector, gap visualization (dashed shaded bands), summary stats (min/max/avg), zoom/pan interaction, and a shared navigation header (Dashboard | History | Health). PostgreSQL database functions for time-bucketed aggregation and gap detection.
</objective>

<execution_context>
@/Users/jarmoniskala/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jarmoniskala/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-history-and-health/03-RESEARCH.md
@.planning/phases/02-live-dashboard/02-01-SUMMARY.md
@.planning/phases/02-live-dashboard/02-02-SUMMARY.md

@lib/types.ts
@lib/constants.ts
@lib/supabase/client.ts
@lib/supabase/server.ts
@app/layout.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database functions, dependencies, navigation, shared hooks, and query layer</name>
  <files>
    supabase/migrations/005_history_functions.sql
    app/layout.tsx
    components/navigation.tsx
    lib/queries/history.ts
    lib/hooks/use-chart-zoom.ts
    lib/hooks/use-persisted-state.ts
    lib/types.ts
    lib/constants.ts
  </files>
  <action>
**Install dependencies:**
```bash
cd /Users/jarmoniskala/Documents/iot && npm install recharts @tanstack/react-table
npx shadcn@latest add table tabs calendar popover --yes
```

Note: Use `--legacy-peer-deps` if React 19 compatibility issues arise (same pattern as Phase 2 @dnd-kit install).

**Create `supabase/migrations/005_history_functions.sql`** with three PostgreSQL functions:

1. `get_sensor_history(p_from timestamptz, p_to timestamptz, p_bucket_minutes integer DEFAULT 60)` — Returns time-bucketed aggregates (bucket, mac_address, avg/min/max for temperature, humidity, pressure_hpa, reading_count). For p_bucket_minutes <= 5, return raw readings (no aggregation). For longer ranges, use `date_trunc('hour', measured_at) + floor(extract(minute)/p_bucket_minutes)*p_bucket_minutes * interval '1 minute'` bucket formula. CRITICAL: Pressure must be divided by 100.0 to convert from Pa to hPa in the SQL (per research pitfall #1). Filter `is_outlier = false`. Language: plpgsql.

2. `detect_gaps(p_from timestamptz, p_to timestamptz, p_gap_threshold_minutes integer DEFAULT 15)` — Uses LAG window function over sensor_readings partitioned by mac_address, ordered by measured_at. Returns rows where the interval between consecutive readings exceeds the threshold (mac_address, gap_start, gap_end, duration_minutes). Filter `is_outlier = false`. Language: sql.

3. `get_summary_stats(p_from timestamptz, p_to timestamptz)` — Returns per-sensor summary for the time range: mac_address, display_name (joined from sensor_config where unassigned_at IS NULL), min/max/round(avg,1) for temperature, humidity, and pressure_hpa (Pa/100). Filter `is_outlier = false`. Language: sql.

**Create `components/navigation.tsx`** — A client component with a horizontal nav bar containing Next.js `<Link>` elements for Dashboard (/), History (/history), Health (/health). Use `usePathname()` from next/navigation to highlight the active link with a bottom border or font weight. Include the app title "Home IoT Monitor" on the left. Include the existing DarkModeToggle component on the right. Style: subtle, minimal — bg-background border-b, sticky top-0 z-50.

**Update `app/layout.tsx`** — Import and render `<Navigation />` between `<Providers>` and `{children}`. Remove any existing header if present so the navigation component owns the full header area.

**Create `lib/hooks/use-persisted-state.ts`** — Generic hook `usePersistedState<T>(key: string, defaultValue: T): [T, (value: T) => void]`. Initializes with defaultValue (SSR-safe), hydrates from localStorage in useEffect, writes to localStorage on every set call. Wrap in try/catch for storage quota and parse errors. Mark `'use client'`.

**Create `lib/hooks/use-chart-zoom.ts`** — Custom hook `useChartZoom(initialLeft: number, initialRight: number)` returning `{ domain, handleWheel, handleMouseDown, handleMouseMove, handleMouseUp, resetZoom }`. Domain is `{ left: number, right: number }` (unix timestamps). handleWheel uses focal-point zoom (cursor position determines zoom center, deltaY > 0 = zoom out with factor 1.2, deltaY < 0 = zoom in with factor 0.8). handleMouseDown/Move/Up implement drag-to-pan. Clamp domain to initial bounds. Throttle is NOT in the hook — the chart component should throttle calls. Mark `'use client'`.

**Create `lib/queries/history.ts`** — Three async functions wrapping Supabase RPC calls:
- `fetchSensorHistory(supabase, from: string, to: string, bucketMinutes: number)` calls `supabase.rpc('get_sensor_history', { p_from, p_to, p_bucket_minutes })`
- `fetchGaps(supabase, from: string, to: string)` calls `supabase.rpc('detect_gaps', { p_from, p_to })`
- `fetchSummaryStats(supabase, from: string, to: string)` calls `supabase.rpc('get_summary_stats', { p_from, p_to })`
- Also export a helper `getBucketMinutes(rangeHours: number): number` — returns 5 for <=24h, 15 for <=168h (7d), 60 for <=720h (30d), else `max(5, floor(rangeHours*60/1500))`.
- Use `createBrowserClient` from `@/lib/supabase/client` for the Supabase instance.

**Extend `lib/types.ts`** — Add interfaces:
- `HistoryBucket` (bucket: string, mac_address: string, avg_temperature/min_temperature/max_temperature, avg_humidity/min_humidity/max_humidity, avg_pressure_hpa/min_pressure_hpa/max_pressure_hpa, reading_count: number)
- `GapInterval` (mac_address: string, gap_start: string, gap_end: string, duration_minutes: number)
- `SummaryStatsRow` (mac_address: string, display_name: string, min_temp/max_temp/avg_temp, min_humidity/max_humidity/avg_humidity, min_pressure_hpa/max_pressure_hpa/avg_pressure_hpa — all number | null)
- `TimeRangePreset` = '24h' | '7d' | '30d' | 'custom'
- `TooltipMode` = 'shared' | 'single'
- `Metric` = 'temperature' | 'humidity' | 'pressure'

**Extend `lib/constants.ts`** — Add:
- `ROOM_COLORS: { mac: string, stroke: string, fill: string }[]` — This will be populated dynamically from sensor config, but define default colors: `['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4']` (blue, violet, amber, red, cyan) for up to 5 rooms.
- `ROOM_COLOR_PALETTE: string[]` = `['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4']`
- `GAP_THRESHOLD_MINUTES = 15` (3 * 5min scan interval, matching STALE_SENSOR_THRESHOLD_MS / 60000)
  </action>
  <verify>
1. `ls supabase/migrations/005_history_functions.sql` — file exists
2. `grep 'get_sensor_history' supabase/migrations/005_history_functions.sql` — function defined
3. `grep 'detect_gaps' supabase/migrations/005_history_functions.sql` — function defined
4. `grep 'get_summary_stats' supabase/migrations/005_history_functions.sql` — function defined
5. `grep 'pressure / 100.0' supabase/migrations/005_history_functions.sql` — Pa to hPa conversion present
6. `npx tsc --noEmit` — TypeScript compiles without errors
7. `ls components/navigation.tsx lib/queries/history.ts lib/hooks/use-chart-zoom.ts lib/hooks/use-persisted-state.ts` — all files exist
8. `grep 'HistoryBucket' lib/types.ts` — type exported
9. `grep 'ROOM_COLOR_PALETTE' lib/constants.ts` — constant exported
  </verify>
  <done>
Database migration with get_sensor_history, detect_gaps, and get_summary_stats functions ready for deployment. Navigation component renders on all pages with Dashboard/History/Health links. Shared hooks (usePersistedState, useChartZoom) and query layer (fetchSensorHistory, fetchGaps, fetchSummaryStats, getBucketMinutes) ready for use. All new types exported from lib/types.ts. Room color palette and gap threshold constant in lib/constants.ts. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: History page with trend chart, time range controls, room selector, gap visualization, and summary stats</name>
  <files>
    app/history/page.tsx
    components/history/history-client.tsx
    components/history/trend-chart.tsx
    components/history/time-range-picker.tsx
    components/history/room-selector.tsx
    components/history/summary-stats.tsx
    components/history/chart-tooltip.tsx
    components/history/gap-tooltip.tsx
  </files>
  <action>
**Create `app/history/page.tsx`** — Server component. `export const dynamic = 'force-dynamic'`. Fetch initial data:
- Use `createClient` from `@/lib/supabase/server` to get Supabase instance.
- Calculate default range: `from = subHours(now, 24)`, `to = now`.
- Call `fetchSensorHistory` with bucketMinutes=5 (raw for 24h).
- Call `fetchGaps` for the same range.
- Call `fetchSummaryStats` for the same range.
- Fetch sensor_config (active sensors: `unassigned_at IS NULL`).
- Render `<HistoryClient initialReadings={readings} initialGaps={gaps} initialStats={stats} sensorConfig={config} />`.

**Create `components/history/history-client.tsx`** — Client component (`'use client'`). Central state manager. Props: initialReadings, initialGaps, initialStats, sensorConfig (types from lib/types.ts).

State managed:
- `metric` via `usePersistedState<Metric>('history-metric', 'temperature')` — tabs to switch metric
- `timeRange` via `usePersistedState<TimeRangePreset>('history-range', '24h')` — preset selection
- `customRange` via `usePersistedState<{ from: string; to: string } | null>('history-custom-range', null)` — custom date range
- `selectedRooms` via `usePersistedState<string[]>('history-rooms', sensorConfig.map(s => s.mac_address))` — room toggle
- `tooltipMode` via `useState<TooltipMode>('shared')` — not persisted, defaults to shared
- `readings`, `gaps`, `stats` in `useState` — initialized from props, updated on refetch
- `loading` state for refetch indicator

When timeRange or customRange changes, refetch data:
- Calculate actual from/to dates based on preset or custom range (use date-fns subHours/subDays).
- Calculate bucketMinutes via `getBucketMinutes`.
- Fetch via `createBrowserClient` from `@/lib/supabase/client` + the query functions.
- Update readings, gaps, stats state.

Layout (top to bottom):
1. Page title "History" + tooltip mode toggle button (small icon: crosshair for shared, pointer for single)
2. Metric tabs (shadcn/ui Tabs): Temperature | Humidity | Pressure
3. `<TimeRangePicker>` — horizontal pill buttons + custom date picker
4. `<RoomSelector>` — room toggle buttons (colored dots matching room palette)
5. `<TrendChart>` — the main chart area
6. `<SummaryStats>` — stat cards below chart

**Create `components/history/trend-chart.tsx`** — Client component. Props: readings (HistoryBucket[]), gaps (GapInterval[]), selectedRooms (string[]), metric (Metric), sensorConfig (SensorConfig[]), tooltipMode (TooltipMode).

Implementation:
- Transform readings into Recharts format: group by bucket timestamp, create one data point per bucket with keys like `{mac_address}` containing the metric value (avg_temperature, avg_humidity, or avg_pressure_hpa based on selected metric). This creates the multi-room overlay structure.
- Use `useChartZoom` with initial domain from the first/last bucket timestamps.
- Wrap chart in a div with onWheel (throttled to 50ms via a ref-based throttle), onMouseDown, onMouseMove, onMouseUp handlers from the zoom hook. Set `cursor: grab` on the container, `cursor: grabbing` during drag.
- Render `<AreaChart>` with `responsive` prop, height 400 (250 on mobile via Tailwind responsive class).
- `<defs>` section: one `<linearGradient>` per selected room using ROOM_COLOR_PALETTE colors.
- `<XAxis>` with `type="number"`, `domain={[domain.left, domain.right]}`, `scale="time"`, tickFormatter showing HH:mm for 24h, MMM d for 7d/30d.
- `<YAxis>` with appropriate label (C, %, hPa) based on metric.
- `<Tooltip>` with `shared={tooltipMode === 'shared'}`, custom `content={<ChartTooltip />}`.
- One `<Area>` per selected room: `type="monotone"`, `dataKey={room.mac_address}`, stroke from palette, fill as `url(#gradient-{mac})`, strokeWidth 2, dot={false}, activeDot={{ r: 4 }}, `isAnimationActive={false}`, `connectNulls={false}`.
- One `<ReferenceArea>` per gap: x1/x2 from gap timestamps, fillOpacity 0.05, strokeDasharray "4 4", with onMouseEnter/onMouseLeave to show/hide a GapTooltip.
- Add a "Reset zoom" button (appears only when zoomed) that calls resetZoom.

**Create `components/history/chart-tooltip.tsx`** — Custom Recharts tooltip component. In shared mode: shows all room values at the timestamp with room name and color dot. In single mode: shows only the active room value. Format timestamp with date-fns. Format values with units (°C, %, hPa). Dark mode aware styling.

**Create `components/history/gap-tooltip.tsx`** — Absolute-positioned tooltip shown on ReferenceArea hover. Shows: "Offline {duration}" and "{gap_start time} — {gap_end time}" (e.g., "Offline 2h 15m — 14:30 to 16:45"). Uses date-fns for formatting. Position tracked via mouse coordinates relative to chart container.

**Create `components/history/time-range-picker.tsx`** — Props: timeRange, onTimeRangeChange, customRange, onCustomRangeChange.
- Horizontal row of pill buttons: 24h | 7d | 30d | Custom.
- Styled as toggle group: selected pill has bg-primary text-primary-foreground, others are ghost.
- When "Custom" is selected, show a shadcn/ui Popover with Calendar in `mode="range"` for start/end date selection. Use react-day-picker's `DateRange` type. Confirm button applies the range.

**Create `components/history/room-selector.tsx`** — Props: sensorConfig, selectedRooms, onSelectedRoomsChange.
- Row of toggle buttons, one per sensor. Each shows a colored dot (from ROOM_COLOR_PALETTE) and room display_name.
- Clicking toggles that room on/off. At least one room must remain selected (prevent deselecting the last one).
- Selected rooms have full opacity + border, deselected rooms are muted.

**Create `components/history/summary-stats.tsx`** — Props: stats (SummaryStatsRow[]), selectedRooms (string[]), metric (Metric).
- Grid of stat cards (responsive: 1 col mobile, 3 cols desktop — one per selected room).
- Each card shows room name (with color dot), then min/max/avg for the selected metric.
- Format: "Min 18.2°C · Max 23.1°C · Avg 20.4°C" (or equivalent for humidity/pressure).
- Filter stats to only show selectedRooms.
  </action>
  <verify>
1. `npx tsc --noEmit` — TypeScript compiles without errors
2. `ls app/history/page.tsx components/history/history-client.tsx components/history/trend-chart.tsx components/history/time-range-picker.tsx components/history/room-selector.tsx components/history/summary-stats.tsx components/history/chart-tooltip.tsx components/history/gap-tooltip.tsx` — all files exist
3. `npm run build` — Next.js build succeeds (or `next build` if script not configured)
4. `grep 'force-dynamic' app/history/page.tsx` — server component has dynamic export
5. `grep 'AreaChart' components/history/trend-chart.tsx` — Recharts AreaChart used
6. `grep 'ReferenceArea' components/history/trend-chart.tsx` — gap visualization present
7. `grep 'useChartZoom' components/history/trend-chart.tsx` — zoom/pan hook connected
8. `grep 'usePersistedState' components/history/history-client.tsx` — localStorage persistence used
9. `grep 'Calendar' components/history/time-range-picker.tsx` — date picker present
  </verify>
  <done>
History page renders at /history with:
- Smooth monotone area charts with gradient fills (Apple Health style) for temperature, humidity, and pressure
- Metric switching via tabs (one metric at a time, rooms overlay)
- Time range picker with 24h | 7d | 30d | Custom pills and calendar date picker popover
- Room toggle buttons to show/hide room lines on the chart
- Scroll-to-zoom and drag-to-pan interaction on the chart with reset zoom button
- Data gap visualization as dashed-line shaded bands with hover tooltip showing offline duration and time range
- Tooltip mode toggle between shared (vertical crosshair showing all rooms) and single (nearest line value)
- Summary stats (min, max, average) displayed below the chart per selected room
- Time range and room selection persisted in localStorage across page reloads
- TypeScript compiles and Next.js builds successfully
  </done>
</task>

</tasks>

<verification>
1. Navigate to /history — page loads with default 24h data and area chart
2. Switch between Temperature, Humidity, and Pressure tabs — chart updates to show the selected metric
3. Click 7d and 30d pills — chart refetches with aggregated data at appropriate bucket sizes
4. Click Custom, select a date range, confirm — chart shows that custom range
5. Toggle room buttons — lines appear/disappear on the chart
6. Scroll to zoom on the chart — X-axis domain narrows/widens centered on cursor
7. Click and drag on the chart — chart pans left/right
8. Click Reset zoom button — chart returns to full range
9. Toggle tooltip mode — shared shows all rooms, single shows nearest
10. Hover over a gap region (if any) — tooltip shows "Offline {duration}" and time range
11. Summary stats below chart show min/max/avg for each selected room
12. Reload page — time range, metric, and room selection restored from localStorage
13. Navigation header shows Dashboard | History | Health links on all pages, active page highlighted
</verification>

<success_criteria>
- Historical area charts render for temperature, humidity, and pressure with smooth curves and gradient fills
- Time range presets (24h, 7d, 30d) and custom date picker all trigger data refetch
- Multiple rooms overlay on the same chart with toggle controls
- Scroll-to-zoom and drag-to-pan work smoothly
- Data gaps visualized as dashed shaded bands with informative hover tooltips
- Summary stats (min, max, average) display below chart for selected rooms
- State persists in localStorage across page reloads
- Navigation header with links to all three pages renders site-wide
- TypeScript compiles and Next.js builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-history-and-health/03-01-SUMMARY.md`
</output>
