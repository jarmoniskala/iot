---
phase: 04-storage-dashboard-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/008_storage_security.sql
  - lib/queries/storage.ts
  - lib/types.ts
  - components/dashboard/storage-widget.tsx
  - components/dashboard/dashboard-client.tsx
  - app/page.tsx
autonomous: true
requirements:
  - PIPE-05

must_haves:
  truths:
    - "Dashboard displays current database size in MB with a progress bar against the 500 MB free-tier limit"
    - "Dashboard shows per-table size breakdown (top tables by size, partitions grouped)"
    - "Storage data timestamp is visible so the user knows how fresh the data is"
    - "Progress bar color changes based on usage threshold (green < 80%, amber 80-90%, red > 90%)"
  artifacts:
    - path: "supabase/migrations/008_storage_security.sql"
      provides: "SECURITY DEFINER for get_database_size_mb and get_table_sizes, RLS for ingestion_log"
      contains: "SECURITY DEFINER"
    - path: "lib/queries/storage.ts"
      provides: "fetchDatabaseSize and fetchTableSizes RPC wrappers"
      exports: ["fetchDatabaseSize", "fetchTableSizes"]
    - path: "lib/types.ts"
      provides: "TableSize type for storage widget"
      contains: "TableSize"
    - path: "components/dashboard/storage-widget.tsx"
      provides: "Storage widget component with progress bar and table breakdown"
      min_lines: 30
    - path: "app/page.tsx"
      provides: "Server-side storage data fetch"
      contains: "fetchDatabaseSize"
  key_links:
    - from: "app/page.tsx"
      to: "lib/queries/storage.ts"
      via: "import and call fetchDatabaseSize, fetchTableSizes"
      pattern: "fetchDatabaseSize|fetchTableSizes"
    - from: "components/dashboard/dashboard-client.tsx"
      to: "components/dashboard/storage-widget.tsx"
      via: "renders StorageWidget with storage props"
      pattern: "StorageWidget"
    - from: "lib/queries/storage.ts"
      to: "supabase.rpc('get_database_size_mb')"
      via: "Supabase RPC call"
      pattern: "supabase\\.rpc\\('get_database_size_mb'\\)"
---

<objective>
Add a storage monitoring widget to the dashboard that displays current database size against the Supabase 500 MB free-tier limit, with a per-table breakdown and threshold-based color coding.

Purpose: Closes the PIPE-05 gap — the PostgreSQL functions and daily cron job for storage monitoring were built in Phase 1 but the front-end display was never built. This gives the user at-a-glance visibility into Supabase free-tier consumption.

Output: A storage card on the dashboard below the room grid showing total DB size, progress bar, top tables by size, and a "checked at" timestamp.
</objective>

<execution_context>
@/Users/jarmoniskala/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jarmoniskala/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-storage-dashboard-widget/04-RESEARCH.md
@supabase/migrations/002_functions.sql
@lib/queries/health.ts
@lib/types.ts
@app/page.tsx
@components/dashboard/dashboard-client.tsx
@components/dashboard/weather-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and storage query layer</name>
  <files>
    supabase/migrations/008_storage_security.sql
    lib/queries/storage.ts
    lib/types.ts
  </files>
  <action>
1. Create `supabase/migrations/008_storage_security.sql`:
   - Recreate `get_database_size_mb()` with `SECURITY DEFINER SET search_path = public` so the anon role can call it via RPC (it internally uses `pg_database_size()` which needs elevated privileges).
   - Recreate `get_table_sizes()` with `SECURITY DEFINER SET search_path = public` for the same reason (uses `pg_stat_user_tables` and `pg_total_relation_size()`).
   - Enable RLS on `ingestion_log` and add a permissive SELECT policy for the anon role (consistent with other tables). This ensures the anon role can read storage check entries from `ingestion_log` as a fallback data source.

   Use `CREATE OR REPLACE FUNCTION` to avoid conflicts with existing migration 002 definitions. Match the exact function signatures from 002_functions.sql but add `SECURITY DEFINER SET search_path = public` to both.

2. Create `lib/queries/storage.ts`:
   - Export `fetchDatabaseSize(supabase: SupabaseClient): Promise<number | null>` — calls `supabase.rpc('get_database_size_mb')`, returns the numeric value or null on error.
   - Export `fetchTableSizes(supabase: SupabaseClient): Promise<TableSize[]>` — calls `supabase.rpc('get_table_sizes')`, returns the array or empty array on error.
   - Both functions should log errors with `console.error` (matching health.ts and history.ts patterns).
   - Import `SupabaseClient` from `@supabase/supabase-js` and `TableSize` from `@/lib/types`.

3. Add `TableSize` type to `lib/types.ts`:
   - Add in a new `// ── Storage types ──` section after the Health types block.
   - `export interface TableSize { table_name: string; size_mb: number; row_estimate: number }` — matches the return shape of `get_table_sizes()`.
  </action>
  <verify>
    - `008_storage_security.sql` contains two `CREATE OR REPLACE FUNCTION` statements with `SECURITY DEFINER`.
    - `008_storage_security.sql` contains `ALTER TABLE ingestion_log ENABLE ROW LEVEL SECURITY` and a SELECT policy.
    - `lib/queries/storage.ts` exports `fetchDatabaseSize` and `fetchTableSizes`.
    - `lib/types.ts` contains `TableSize` interface.
    - `npx tsc --noEmit` passes (or no new type errors introduced).
  </verify>
  <done>
    Migration file exists with SECURITY DEFINER functions and ingestion_log RLS policy. Query layer file exports two typed RPC wrapper functions. TableSize type is defined in the shared types file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Storage widget component and dashboard integration</name>
  <files>
    components/dashboard/storage-widget.tsx
    components/dashboard/dashboard-client.tsx
    app/page.tsx
  </files>
  <action>
1. Create `components/dashboard/storage-widget.tsx`:
   - `'use client'` component.
   - Props: `sizeMb: number | null`, `checkedAt: string | null`, `tableSizes: TableSize[]` (import `TableSize` from `@/lib/types`).
   - If `sizeMb` is null, render nothing (return null).
   - Layout follows the dashboard card pattern from weather-panel.tsx: `bg-card border border-border rounded-lg p-5`.
   - **Header row:** Database icon (from lucide-react) + "Storage" label — same sizing as weather panel header (`h-6 w-6` icon, `text-[1.2rem]` label).
   - **Hero metric:** `{sizeMb.toFixed(1)} / 500 MB` — large number (`text-[1.728rem] font-light leading-none tabular-nums`) with the "/ 500 MB" as smaller muted text.
   - **Progress bar:** Outer div `h-2 bg-muted rounded-full overflow-hidden`, inner div with dynamic width `style={{ width: \`${pct}%\` }}`. Color: emerald-500 if under 80%, amber-500 if 80-90%, red-500 if over 90%. Percentage is `Math.min((sizeMb / 500) * 100, 100)`.
   - **Table breakdown:** Show top 5 tables by size (already ordered by size from the RPC). For each table, a flex row with table name (muted, truncated) and size in MB (tabular-nums). Filter out partition tables: skip entries where `table_name` matches the pattern `_\d{4}_\d{2}$` or `_default$`. Strip the `public.` schema prefix from display names for cleanliness.
   - **Timestamp:** "Checked {formatDistanceToNow(new Date(checkedAt), { addSuffix: true })}" in small muted text at the bottom. Import `formatDistanceToNow` from `date-fns` (already installed).

2. Update `app/page.tsx`:
   - Import `fetchDatabaseSize` and `fetchTableSizes` from `@/lib/queries/storage`.
   - After the existing weather fetch block, add two parallel RPC calls: `const [{ data: dbSize }, { data: rawTableSizes }] = await Promise.all([supabase.rpc('get_database_size_mb'), supabase.rpc('get_table_sizes')])`. Actually, use the wrapper functions instead — call `const dbSizeMb = await fetchDatabaseSize(supabase)` and `const tableSizes = await fetchTableSizes(supabase)`.
   - Pass `storageSizeMb={dbSizeMb}`, `storageCheckedAt={new Date().toISOString()}` (RPC gives live data, so "checked at" is now), and `tableSizes={tableSizes}` as new props to `DashboardClient`.

3. Update `components/dashboard/dashboard-client.tsx`:
   - Add new props: `storageSizeMb: number | null`, `storageCheckedAt: string | null`, `tableSizes: TableSize[]`.
   - Import `TableSize` from `@/lib/types` and `StorageWidget` from `./storage-widget`.
   - Render `<StorageWidget sizeMb={storageSizeMb} checkedAt={storageCheckedAt} tableSizes={tableSizes} />` below the room cards section, inside the `max-w-7xl mx-auto px-4 sm:px-5 pb-8` wrapper. Place it after the closing `</div>` of the room cards container but before the edit dialog.
  </action>
  <verify>
    - `components/dashboard/storage-widget.tsx` exists and exports `StorageWidget`.
    - `app/page.tsx` imports and calls `fetchDatabaseSize` and `fetchTableSizes`, passes results to DashboardClient.
    - `components/dashboard/dashboard-client.tsx` renders `StorageWidget` with storage props.
    - `npx tsc --noEmit` passes.
    - `npm run build` completes without errors.
  </verify>
  <done>
    Dashboard displays a storage widget below the room cards showing the database size in MB against the 500 MB limit, with a color-coded progress bar, per-table breakdown (partitions filtered), and a freshness timestamp.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npm run build` — Next.js build succeeds
3. Visual check: dashboard page shows weather panel, room cards, and storage widget in that order
4. Storage widget displays: hero metric (X.X / 500 MB), colored progress bar, table list, timestamp
5. Migration file is syntactically valid SQL with SECURITY DEFINER on both functions
</verification>

<success_criteria>
- Dashboard shows current database size with progress bar against 500 MB limit
- Progress bar is green (< 80%), amber (80-90%), or red (> 90%)
- Per-table breakdown visible (partition tables filtered out)
- Timestamp shows when data was last checked
- No new dependencies added
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-storage-dashboard-widget/04-01-SUMMARY.md`
</output>
