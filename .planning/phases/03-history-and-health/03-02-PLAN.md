---
phase: 03-history-and-health
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - supabase/migrations/006_health_functions.sql
  - app/health/page.tsx
  - components/health/health-client.tsx
  - components/health/health-table.tsx
  - components/health/health-row-detail.tsx
  - components/health/severity-badge.tsx
  - lib/queries/health.ts
  - lib/types.ts
  - components/dashboard/room-card.tsx
autonomous: true
requirements: [HLTH-01, HLTH-02, HLTH-03, HLTH-04]

must_haves:
  truths:
    - "User can view a dedicated health page with a sortable table showing all sensors"
    - "Health table shows battery voltage, signal strength, movement counter, last seen, and uptime % per sensor"
    - "Table rows are color-coded by severity: green (healthy), amber (warning), red (critical)"
    - "User can click a sensor row to expand and see battery voltage and signal strength trend charts"
    - "Health table columns are sortable by clicking column headers"
    - "Measurement sequence gaps and total gap time are shown per sensor"
    - "Dashboard room cards show subtle warning icons when battery is low or data is stale, linking to /health"
  artifacts:
    - path: "supabase/migrations/006_health_functions.sql"
      provides: "PostgreSQL function for sensor health summary with uptime calculation"
      contains: "get_sensor_health"
    - path: "app/health/page.tsx"
      provides: "Server component fetching sensor health data"
      exports: ["default"]
    - path: "components/health/health-client.tsx"
      provides: "Client wrapper managing table state (sorting, expansion)"
    - path: "components/health/health-table.tsx"
      provides: "@tanstack/react-table sortable/expandable table with severity row coloring"
    - path: "components/health/health-row-detail.tsx"
      provides: "Expandable row content with battery and RSSI mini trend charts"
    - path: "components/health/severity-badge.tsx"
      provides: "Color-coded severity indicator component"
    - path: "lib/queries/health.ts"
      provides: "Supabase query wrappers for health RPC calls"
  key_links:
    - from: "app/health/page.tsx"
      to: "lib/queries/health.ts"
      via: "Server-side health data fetch"
      pattern: "fetchSensorHealth"
    - from: "components/health/health-table.tsx"
      to: "@tanstack/react-table"
      via: "Table state management (sorting, expansion)"
      pattern: "useReactTable|getSortedRowModel|getExpandedRowModel"
    - from: "components/health/health-row-detail.tsx"
      to: "recharts"
      via: "Mini trend charts for battery and RSSI"
      pattern: "AreaChart|Area"
    - from: "components/dashboard/room-card.tsx"
      to: "app/health/page.tsx"
      via: "Warning icon links to health page"
      pattern: "Link.*href.*health"
---

<objective>
System health page with sortable/expandable sensor table, severity indicators, and battery/RSSI trend charts in expanded rows. Plus health warning icons on dashboard room cards.

Purpose: Users can verify all sensors are operating correctly, spot battery or connectivity issues at a glance, and drill into detailed voltage and signal trends per sensor.

Output: Health page at /health with @tanstack/react-table sortable table showing battery, RSSI, movement, last seen, uptime %, and gap time per sensor. Color-coded severity rows (green/amber/red). Expandable rows reveal battery voltage and RSSI trend mini-charts. Dashboard room cards gain subtle warning icons linking to /health.
</objective>

<execution_context>
@/Users/jarmoniskala/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jarmoniskala/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-history-and-health/03-RESEARCH.md
@.planning/phases/03-history-and-health/03-01-SUMMARY.md

@lib/types.ts
@lib/constants.ts
@lib/supabase/client.ts
@lib/supabase/server.ts
@lib/queries/history.ts
@components/dashboard/room-card.tsx
@components/navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Health database function, query layer, types, and health page with sortable expandable table</name>
  <files>
    supabase/migrations/006_health_functions.sql
    app/health/page.tsx
    components/health/health-client.tsx
    components/health/health-table.tsx
    components/health/health-row-detail.tsx
    components/health/severity-badge.tsx
    lib/queries/health.ts
    lib/types.ts
  </files>
  <action>
**Create `supabase/migrations/006_health_functions.sql`** with two functions:

1. `get_sensor_health(p_hours integer DEFAULT 24)` — CTE-based function returning per-sensor health stats. Uses three CTEs:
   - `latest`: DISTINCT ON (mac_address) ordered by measured_at DESC — gets latest battery_voltage, rssi, movement_counter, measured_at per sensor.
   - `gaps`: LAG window function over sensor_readings (same pattern as detect_gaps in 005) but summing all gap durations > 15min per sensor for the time window.
   - `counts`: COUNT(*) per mac_address for total readings in the window.
   - Final SELECT joins latest with sensor_config (unassigned_at IS NULL), LEFT JOINs gaps and counts. Calculates uptime_pct as `round((1.0 - coalesce(gap_minutes, 0) / (p_hours * 60.0)) * 100, 1)`. Returns: mac_address, display_name, latest_battery_voltage, latest_rssi, latest_movement_counter, last_seen, total_readings, total_gap_minutes, uptime_pct. Language: sql.

2. `get_sensor_health_trend(p_mac text, p_hours integer DEFAULT 168)` — Returns raw battery_voltage and rssi readings for a single sensor over the time window, ordered by measured_at. Used for the expandable row mini-charts. Returns: measured_at, battery_voltage, rssi. Filter is_outlier = false. Language: sql.

**Extend `lib/types.ts`** — Add interfaces:
- `SensorHealth` (mac_address: string, display_name: string, latest_battery_voltage: number | null, latest_rssi: number | null, latest_movement_counter: number | null, last_seen: string, total_readings: number, total_gap_minutes: number, uptime_pct: number)
- `SensorHealthTrend` (measured_at: string, battery_voltage: number | null, rssi: number | null)
- `SeverityLevel` = 'healthy' | 'warning' | 'critical'

**Create `lib/queries/health.ts`** — Three async functions:
- `fetchSensorHealth(supabase, hours: number = 24)` calls `supabase.rpc('get_sensor_health', { p_hours: hours })`
- `fetchSensorHealthTrend(supabase, mac: string, hours: number = 168)` calls `supabase.rpc('get_sensor_health_trend', { p_mac: mac, p_hours: hours })`
- `getSeverity(sensor: SensorHealth): SeverityLevel` — Pure function: critical if last_seen is older than STALE_SENSOR_THRESHOLD_MS (from constants.ts) OR battery_voltage < BATTERY_LOW_THRESHOLD_V. Warning if uptime_pct < 90 OR battery_voltage < 2.6. Otherwise healthy.

**Create `app/health/page.tsx`** — Server component. `export const dynamic = 'force-dynamic'`. Fetch `get_sensor_health(24)` via Supabase server client. Render `<HealthClient initialHealth={healthData} />`.

**Create `components/health/health-client.tsx`** — Client component (`'use client'`). Props: initialHealth (SensorHealth[]). Manages sorting and expansion state. Renders a page header ("System Health") and `<HealthTable>`. No localStorage persistence needed for health page state.

**Create `components/health/health-table.tsx`** — Client component using @tanstack/react-table. Props: data (SensorHealth[]).

Column definitions:
1. Expand toggle (chevron icon, rotates on expand)
2. Sensor name (display_name) — sortable
3. Battery (latest_battery_voltage, formatted to 2 decimal places + "V") — sortable
4. Signal (latest_rssi, formatted as dBm) — sortable
5. Movement (latest_movement_counter) — sortable
6. Last seen (last_seen, formatted as relative time via date-fns formatDistanceToNow) — sortable
7. Uptime (uptime_pct, formatted as percentage) — sortable
8. Gap time (total_gap_minutes, formatted as hours:minutes) — sortable
9. Status (SeverityBadge component)

Table configuration:
- `useReactTable` with `getCoreRowModel()`, `getSortedRowModel()`, `getExpandedRowModel()`
- Default sort: by display_name ascending. Critical-severity sensors float to top (use custom sort function that prioritizes severity, then name).
- Render with shadcn/ui Table, TableHeader, TableBody, TableRow, TableHead, TableCell.
- Row background color based on severity: healthy = default, warning = `bg-amber-500/5 dark:bg-amber-500/10`, critical = `bg-red-500/5 dark:bg-red-500/10`.
- Expanded rows render `<HealthRowDetail>` in a full-width `<TableCell>` with colspan.
- Column headers have sort indicators (arrow up/down) and are clickable to toggle sort.

**Create `components/health/health-row-detail.tsx`** — Client component. Props: sensor (SensorHealth). On mount, fetches 7-day trend data via `fetchSensorHealthTrend` using `createBrowserClient`. Caches the result in component state (no re-fetch if re-expanded within component lifecycle).

Renders two side-by-side mini area charts (Recharts AreaChart, height 150):
1. Battery voltage trend (7 days) — blue gradient fill, Y-axis label "V", horizontal reference line at BATTERY_LOW_THRESHOLD_V (dashed, red).
2. RSSI trend (7 days) — violet gradient fill, Y-axis label "dBm".

Both charts: `type="monotone"`, `isAnimationActive={false}`, `dot={false}`, responsive width. XAxis shows date ticks. Show loading skeleton while fetching.

On mobile (<640px), stack charts vertically instead of side-by-side.

**Create `components/health/severity-badge.tsx`** — Props: severity (SeverityLevel). Renders a small pill/badge:
- healthy: green dot + "Healthy" text, `bg-emerald-500/15 text-emerald-700 dark:text-emerald-400`
- warning: amber dot + "Warning" text, `bg-amber-500/15 text-amber-700 dark:text-amber-400`
- critical: red dot + "Critical" text, `bg-red-500/15 text-red-700 dark:text-red-400`
  </action>
  <verify>
1. `ls supabase/migrations/006_health_functions.sql` — file exists
2. `grep 'get_sensor_health' supabase/migrations/006_health_functions.sql` — function defined
3. `grep 'get_sensor_health_trend' supabase/migrations/006_health_functions.sql` — trend function defined
4. `npx tsc --noEmit` — TypeScript compiles without errors
5. `ls app/health/page.tsx components/health/health-client.tsx components/health/health-table.tsx components/health/health-row-detail.tsx components/health/severity-badge.tsx lib/queries/health.ts` — all files exist
6. `grep 'useReactTable' components/health/health-table.tsx` — @tanstack/react-table used
7. `grep 'getSortedRowModel' components/health/health-table.tsx` — sorting enabled
8. `grep 'getExpandedRowModel' components/health/health-table.tsx` — expansion enabled
9. `grep 'AreaChart' components/health/health-row-detail.tsx` — mini charts present
10. `grep 'SensorHealth' lib/types.ts` — type exported
  </verify>
  <done>
Health page renders at /health with a sortable table showing all sensors with battery voltage, signal strength, movement counter, last seen, uptime %, and gap time. Rows are color-coded by severity (green/amber/red). Clicking a row expands it to show 7-day battery voltage and RSSI trend mini-charts. Table columns are sortable. Critical sensors float to top. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard health warning icons linking to health page</name>
  <files>
    components/dashboard/room-card.tsx
  </files>
  <action>
**Modify `components/dashboard/room-card.tsx`** — Add subtle health warning icons that link to the /health page.

Add two warning conditions (using existing data already passed to the room card):
1. **Low battery**: If `battery_voltage` is not null and < `BATTERY_LOW_THRESHOLD_V` (from constants.ts), show a Battery warning icon (lucide-react `BatteryLow` or `BatteryWarning`).
2. **Stale data**: If the sensor reading is stale (using `isSensorStale` from lib/staleness.ts — this logic already exists in the card for dimming), show an `AlertTriangle` icon from lucide-react.

Implementation:
- Import `Link` from `next/link`.
- In the card header area (near the existing edit button), add a warning icon group.
- Each warning icon is wrapped in `<Link href="/health">` so clicking navigates to the health page.
- Style: `text-amber-500 dark:text-amber-400` for battery warning, `text-red-500 dark:text-red-400` for stale data warning. Size: `h-4 w-4`. Use a subtle animation: `animate-pulse` only for critical (stale) warning to draw attention without being obnoxious.
- Icons appear conditionally — if no warnings, nothing is shown.
- Tooltip (title attribute) on each icon: "Low battery — view health" and "Stale data — view health".
- Position: absolute top-right of the card, or inline in the header next to the edit button. Use the existing `group-hover:opacity-100` pattern but keep warning icons always visible (they are important signals, not secondary actions).
  </action>
  <verify>
1. `npx tsc --noEmit` — TypeScript compiles without errors
2. `npm run build` — Next.js build succeeds
3. `grep 'BatteryWarning\|BatteryLow' components/dashboard/room-card.tsx` — battery icon imported
4. `grep 'AlertTriangle' components/dashboard/room-card.tsx` — stale icon imported
5. `grep 'href.*health' components/dashboard/room-card.tsx` — link to health page present
6. `grep 'BATTERY_LOW_THRESHOLD_V' components/dashboard/room-card.tsx` — threshold constant used
  </verify>
  <done>
Dashboard room cards show subtle warning icons when battery is low (amber battery icon) or data is stale (red alert triangle icon). Both icons link to /health for details. Warning icons are always visible (not hidden behind hover). No warnings shown when sensor is healthy. TypeScript compiles and Next.js builds successfully.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /health — page loads with sensor health table
2. Table shows all active sensors with battery, signal, movement, last seen, uptime %, gap time columns
3. Click column headers — table sorts by that column
4. Rows are color-coded: green (healthy), amber (warning), red (critical)
5. Click a sensor row — it expands to show battery voltage and RSSI 7-day trend mini-charts
6. Click the expanded row again — it collapses
7. Navigate to / (dashboard) — room cards with low battery or stale data show warning icons
8. Click a warning icon — navigates to /health
9. Navigation header works on all three pages (Dashboard, History, Health)
10. `npm run build` succeeds without errors
</verification>

<success_criteria>
- Health page displays a sortable table with all sensor health metrics (battery, signal, movement, last seen, uptime, gaps)
- Table rows are color-coded by severity with critical sensors floating to top
- Expanding a row shows 7-day battery voltage and RSSI trend charts
- Dashboard room cards display warning icons for low battery and stale data, linking to /health
- @tanstack/react-table manages sorting and expansion state
- All pages accessible via the navigation header created in plan 03-01
- TypeScript compiles and Next.js builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-history-and-health/03-02-SUMMARY.md`
</output>
