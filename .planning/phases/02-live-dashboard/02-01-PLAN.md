---
phase: 02-live-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/layout.tsx
  - app/page.tsx
  - app/globals.css
  - app/providers.tsx
  - app/error.tsx
  - components/dashboard/realtime-provider.tsx
  - components/dashboard/room-card.tsx
  - components/dashboard/room-grid.tsx
  - components/dashboard/weather-panel.tsx
  - components/dashboard/dark-mode-toggle.tsx
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/comfort.ts
  - lib/weather.ts
  - lib/staleness.ts
  - lib/constants.ts
  - lib/types.ts
  - supabase/migrations/004_realtime_and_views.sql
  - .env.local
  - package.json
  - next.config.ts
  - tsconfig.json
autonomous: true
requirements:
  - LIVE-01
  - LIVE-02
  - LIVE-03
  - LIVE-04
  - LIVE-05
  - LIVE-06
  - LIVE-07
  - COMP-01
  - COMP-02
  - COMP-03

must_haves:
  truths:
    - "User sees current temperature, humidity, and pressure for bedroom, kid's room, and living room on a single page"
    - "User sees outdoor weather from FMI (temperature, humidity, wind, pressure, precipitation, cloud cover) alongside indoor readings"
    - "Each room card shows dew point, absolute humidity, and comfort classification"
    - "Each room card shows relative timestamp and visual staleness warning when data is stale"
    - "Each room card shows battery warning icon when voltage is below threshold"
    - "Dashboard updates in real time when new sensor data is inserted into the database"
    - "Dashboard renders as dark mode by default on first visit"
    - "Layout is responsive with 2-column card grid on mobile and side panel on desktop"
  artifacts:
    - path: "app/page.tsx"
      provides: "Server component that fetches latest sensor readings and weather from Supabase"
      contains: "createClient"
    - path: "components/dashboard/realtime-provider.tsx"
      provides: "Client component managing Supabase Realtime subscriptions for sensor_readings and weather_observations"
      contains: "postgres_changes"
    - path: "components/dashboard/room-card.tsx"
      provides: "Room card displaying temperature, humidity, pressure, comfort metrics, staleness, and battery"
      contains: "dewPoint"
    - path: "components/dashboard/weather-panel.tsx"
      provides: "Outdoor weather panel displaying all FMI fields with condition icon"
      contains: "weatherCondition"
    - path: "lib/comfort.ts"
      provides: "Dew point, absolute humidity, and comfort classification functions"
      exports: ["dewPoint", "absoluteHumidity", "classifyComfort"]
    - path: "lib/weather.ts"
      provides: "Weather condition derivation from WMO 4680 code and fallback from cloud cover"
      exports: ["weatherConditionFromCode", "weatherConditionFromCloudCover", "windDirectionToCompass", "precipitationLabel"]
    - path: "lib/staleness.ts"
      provides: "Staleness detection for sensors and weather"
      exports: ["isSensorStale", "isWeatherStale"]
    - path: "supabase/migrations/004_realtime_and_views.sql"
      provides: "Realtime publication, latest reading views, and RLS policies"
      contains: "supabase_realtime"
  key_links:
    - from: "app/page.tsx"
      to: "lib/supabase/server.ts"
      via: "Server component fetches initial data from Supabase"
      pattern: "createClient.*latest_sensor_readings"
    - from: "components/dashboard/realtime-provider.tsx"
      to: "lib/supabase/client.ts"
      via: "Client component subscribes to Realtime channel"
      pattern: "postgres_changes.*sensor_readings"
    - from: "components/dashboard/room-card.tsx"
      to: "lib/comfort.ts"
      via: "Card computes and displays dew point, absolute humidity, comfort class"
      pattern: "dewPoint|absoluteHumidity|classifyComfort"
    - from: "components/dashboard/weather-panel.tsx"
      to: "lib/weather.ts"
      via: "Panel derives weather condition from wawa code"
      pattern: "weatherConditionFromCode"
    - from: "supabase/migrations/004_realtime_and_views.sql"
      to: "sensor_readings, weather_observations"
      via: "ALTER PUBLICATION enables Realtime events on data tables"
      pattern: "ALTER PUBLICATION supabase_realtime ADD TABLE"
---

<objective>
Set up the Next.js project with all dependencies and build the complete live dashboard showing current indoor sensor readings per room (temperature, humidity, pressure, comfort metrics, staleness, battery) and outdoor FMI weather data, updated in real time via Supabase Realtime subscriptions.

Purpose: This is the primary value of the entire project -- a single page where the user sees the climate across every room and outdoors at a glance.

Output: A deployable Next.js application with live-updating dashboard, database migration for Realtime, and all supporting utility functions.
</objective>

<execution_context>
@/Users/jarmoniskala/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jarmoniskala/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-live-dashboard/02-CONTEXT.md
@.planning/phases/02-live-dashboard/02-RESEARCH.md
@.planning/phases/01-data-pipeline/01-01-SUMMARY.md
@supabase/migrations/001_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js project scaffold, dependencies, Supabase clients, database migration, types, and utility functions</name>
  <files>
    package.json
    next.config.ts
    tsconfig.json
    app/globals.css
    app/layout.tsx
    app/providers.tsx
    app/error.tsx
    .env.local
    lib/supabase/client.ts
    lib/supabase/server.ts
    lib/types.ts
    lib/comfort.ts
    lib/weather.ts
    lib/staleness.ts
    lib/constants.ts
    supabase/migrations/004_realtime_and_views.sql
  </files>
  <action>
    **Project scaffold:**
    Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias "@/*" --turbopack` from the project root. This creates the Next.js 16 App Router project with Tailwind v4 CSS-first config.

    IMPORTANT: The project root already has a `supabase/` directory from Phase 1. Ensure create-next-app does not overwrite it. If it prompts about existing files, accept overwriting only non-supabase files. After scaffold, verify `supabase/migrations/` still contains 001, 002, 003 SQL files.

    **Install dependencies:**
    ```bash
    npm install @supabase/supabase-js @supabase/ssr date-fns next-themes
    npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
    ```

    **shadcn/ui setup:**
    Run `npx shadcn@latest init` -- accept defaults (New York style, Zinc base color, CSS variables: yes). Then add components:
    ```bash
    npx shadcn@latest add card badge button separator skeleton collapsible
    ```

    **Environment variables:**
    Create `.env.local` with:
    ```
    NEXT_PUBLIC_SUPABASE_URL=your-supabase-project-url
    NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
    ```

    **Supabase client utilities:**
    Create `lib/supabase/client.ts` -- browser client using `createBrowserClient` from `@supabase/ssr` (see RESEARCH.md Pattern 3 for exact code). This is used by client components and Realtime subscriptions.

    Create `lib/supabase/server.ts` -- server client using `createServerClient` from `@supabase/ssr` with cookie handling (see RESEARCH.md Pattern 3 for exact code). This is used by the server component page.tsx for initial data fetch.

    **TypeScript types (`lib/types.ts`):**
    Define interfaces matching the database schema from `001_schema.sql`:
    - `SensorReading` -- all columns from sensor_readings table (mac_address, measured_at, temperature, humidity, pressure, battery_voltage, rssi, movement_counter, tx_power, accel_x/y/z, measurement_sequence, data_format, sensor_name, is_outlier, outlier_reason, raw_payload, created_at)
    - `WeatherObservation` -- all columns from weather_observations table (observed_at, fmisid, temperature, wind_speed, wind_gust, wind_direction, humidity, dew_point, precipitation_1h, precipitation_intensity, snow_depth, pressure, visibility, cloud_cover, weather_code, raw_values, created_at)
    - `SensorConfig` -- all columns from sensor_config table (id, mac_address, display_name, room_name, assigned_at, unassigned_at, notes, created_at)
    - `LatestSensorReading` -- extends SensorReading with display_name and room_name from the view join
    - `ComfortClass` type -- 'dry' | 'comfortable' | 'humid' | 'very_humid'
    - `ComfortResult` interface -- { class: ComfortClass, label: string, color: string }
    - `WeatherCondition` interface -- { label: string, icon: string }
    - `SortMode` type -- 'alphabetical' | 'temperature' | 'custom'

    **Utility functions:**

    Create `lib/comfort.ts` with exact implementations from RESEARCH.md:
    - `dewPoint(tempC, rh)` -- Magnus-Tetens approximation (a=17.625, b=243.04)
    - `absoluteHumidity(tempC, rh)` -- Bolton (1980) saturation vapor pressure formula
    - `classifyComfort(rh)` -- dry (<30%), comfortable (30-60%), humid (60-70%), very humid (>70%). Returns { class, label, color } where color is the Tailwind color name (yellow, green, orange, red) per user's locked decision.

    Create `lib/weather.ts` with exact implementations from RESEARCH.md:
    - `weatherConditionFromCode(wawaCode)` -- WMO 4680 wawa code lookup. Returns { label, icon } where icon is a lucide-react icon component name.
    - `weatherConditionFromCloudCover(cloudCoverOktas, precipitationMm)` -- fallback when wawa is null/NaN
    - `precipitationLabel(mm)` -- format as "2.1 mm -- Light rain" per user's locked decision
    - `windDirectionToCompass(degrees)` -- 16-point compass direction

    Create `lib/staleness.ts` with exact implementations from RESEARCH.md:
    - `isSensorStale(measuredAt, now?)` -- stale if >3 minutes old (3 * 60s default cycle)
    - `isWeatherStale(observedAt, now?)` -- stale if >30 minutes old (3 * 10min FMI cycle)
    - `useNow(intervalMs = 30000)` -- custom React hook that forces re-render every 30s so relative timestamps update. Uses useState + setInterval.

    Create `lib/constants.ts`:
    - `BATTERY_LOW_THRESHOLD_V = 2.4` -- per RESEARCH.md recommendation
    - `ROOM_ICONS` -- map of room_name to lucide-react icon component name: bedroom -> 'Bed', "kid's room" -> 'Baby', 'living room' -> 'Sofa', default -> 'Home'
    - `COMFORT_COLORS` -- map ComfortClass to Tailwind classes for badge, card tint, and text
    - `STALE_SENSOR_THRESHOLD_MS = 180_000` (3 min)
    - `STALE_WEATHER_THRESHOLD_MS = 1_800_000` (30 min)

    **Database migration (`supabase/migrations/004_realtime_and_views.sql`):**
    Create migration with exact SQL from RESEARCH.md:
    1. `ALTER PUBLICATION supabase_realtime ADD TABLE sensor_readings;`
    2. `ALTER PUBLICATION supabase_realtime ADD TABLE weather_observations;`
    3. `ALTER PUBLICATION supabase_realtime ADD TABLE sensor_config;`
    4. Create `latest_sensor_readings` view -- DISTINCT ON (mac_address) with JOIN to sensor_config for display_name and room_name, WHERE measured_at > now() - interval '1 hour' AND is_outlier = false, ORDER BY mac_address, measured_at DESC
    5. Create `latest_weather` view -- SELECT * FROM weather_observations WHERE observed_at > now() - interval '1 hour' ORDER BY observed_at DESC LIMIT 1
    6. Enable RLS on sensor_readings, weather_observations, sensor_config
    7. Create permissive SELECT policies (USING true) on all three tables for anonymous read access
    8. Create permissive UPDATE policy on sensor_config (USING true, WITH CHECK true) for room name/icon editing

    **Root layout and providers:**
    Create `app/providers.tsx` -- client component wrapping ThemeProvider from next-themes with attribute="class", defaultTheme="dark", enableSystem, disableTransitionOnChange (see RESEARCH.md Pattern 4).

    Update `app/layout.tsx` -- import Providers, wrap children. Use Geist font from `next/font/google` for the Linear/Vercel aesthetic. Add `suppressHydrationWarning` to html tag. Import globals.css.

    Update `app/globals.css` -- Tailwind v4 CSS-first config with @theme inline. Define dark mode color variables using shadcn/ui zinc palette with OKLCH values. Ensure comfort classification colors (green, yellow, orange, red) work in both themes.

    Create `app/error.tsx` -- Next.js error boundary with "Something went wrong" message and retry button. Client component with `'use client'`.
  </action>
  <verify>
    1. `npm run build` completes without TypeScript or build errors
    2. `ls supabase/migrations/` shows all 4 migration files (001, 002, 003, 004)
    3. `cat lib/comfort.ts` contains dewPoint, absoluteHumidity, classifyComfort exports
    4. `cat lib/weather.ts` contains weatherConditionFromCode, windDirectionToCompass exports
    5. `cat lib/staleness.ts` contains isSensorStale, isWeatherStale, useNow exports
    6. `cat lib/types.ts` contains SensorReading, WeatherObservation, SensorConfig interfaces
    7. `cat supabase/migrations/004_realtime_and_views.sql` contains ALTER PUBLICATION and CREATE VIEW
  </verify>
  <done>
    Next.js project builds successfully with all dependencies installed. Supabase browser and server clients are configured. All utility functions (comfort, weather, staleness, constants) are implemented with correct formulas. Database migration enables Realtime, creates efficient views, and sets up RLS policies. TypeScript types match the Phase 1 schema exactly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page with room cards, weather panel, Realtime subscriptions, and responsive layout</name>
  <files>
    app/page.tsx
    components/dashboard/realtime-provider.tsx
    components/dashboard/room-card.tsx
    components/dashboard/room-grid.tsx
    components/dashboard/weather-panel.tsx
    components/dashboard/dark-mode-toggle.tsx
  </files>
  <action>
    **RealtimeProvider (`components/dashboard/realtime-provider.tsx`):**
    Client component that wraps the dashboard and manages Supabase Realtime subscriptions (see RESEARCH.md Pattern 2 for reference structure). Must:
    - Accept `initialReadings: LatestSensorReading[]` and `initialWeather: WeatherObservation | null` as props
    - Initialize state with a `Map<string, LatestSensorReading>` keyed by mac_address
    - Subscribe to `postgres_changes` on `sensor_readings` table (INSERT events) and update the map for the corresponding mac_address
    - Subscribe to `postgres_changes` on `weather_observations` table (INSERT events) and update weather state
    - Clean up with `supabase.removeChannel(channel)` in useEffect cleanup (NOT channel.unsubscribe())
    - Pass `readings` map and `weather` object to children via render props or context
    - Handle channel error/timeout states gracefully (log warning, data still shows from initial fetch)

    **RoomCard (`components/dashboard/room-card.tsx`):**
    Client component displaying a single room's data. Uses shadcn/ui Card component. Must implement ALL user locked decisions:
    - Room identification: Icon from ROOM_ICONS mapping + room display_name. Use lucide-react dynamic icon rendering (import icons individually: Bed, Baby, Sofa, Home).
    - Temperature as PRIMARY reading -- large font size (text-3xl or text-4xl), centered or prominent
    - Humidity and pressure as SECONDARY readings -- smaller font (text-sm), below temperature
    - Pressure conversion: call `sensorPressureToHpa(pressure)` (divide by 100) for display. Show as "1013.2 hPa"
    - Comfort metrics ALWAYS VISIBLE on card (not behind expand):
      - Dew point: computed via `dewPoint(temperature, humidity)`, displayed as "Dp: 12.3°C"
      - Absolute humidity: computed via `absoluteHumidity(temperature, humidity)`, displayed as "AH: 8.5 g/m³"
      - Comfort classification: computed via `classifyComfort(humidity)`, shown as color-coded Badge (shadcn/ui), subtle card background tint (bg-{color}-500/5), AND text label (all three per user decision)
    - Relative timestamp: use `formatDistanceToNow(measuredAt, { addSuffix: true })` from date-fns. Use `useNow()` hook to force re-render every 30s so timestamps stay fresh. Always visible on card.
    - Staleness: when `isSensorStale(measuredAt, now)` returns true, dim the card (opacity-50 or similar), add gray overlay tint, show AlertTriangle icon from lucide-react, and change timestamp to "Last seen X min ago"
    - Battery: HIDDEN by default. Only show when `battery_voltage < BATTERY_LOW_THRESHOLD_V` (2.4V). When shown, display BatteryLow icon from lucide-react with warning color.
    - Color scheme per user decision: green=comfortable, yellow=dry, orange=humid, red=very humid. Apply to Badge variant, card background tint, and comfort label text.

    **WeatherPanel (`components/dashboard/weather-panel.tsx`):**
    Client component displaying outdoor FMI weather. DISTINCT visual section from room cards (per user decision -- NOT same card format). Must:
    - Display weather condition: derive from `weatherConditionFromCode(weather.weather_code)` with fallback to `weatherConditionFromCloudCover(weather.cloud_cover, weather.precipitation_1h)` when weather_code is null/NaN. Show the condition icon (lucide-react) + text label prominently.
    - Temperature: large display like room cards
    - All FMI fields: humidity, wind speed, wind direction (as rotating arrow icon + compass direction via `windDirectionToCompass()`), pressure (already in hPa from FMI), precipitation with descriptive label via `precipitationLabel()`, cloud cover (in oktas with descriptive text)
    - Relative timestamp: "Updated 10 min ago" using formatDistanceToNow. Use useNow() hook.
    - Staleness: when `isWeatherStale()` is true, show warning indicator
    - Desktop layout: side panel beside room cards (use flex-row with lg: breakpoint)
    - Mobile layout: stacked below room cards. COLLAPSIBLE -- collapsed state shows temperature + condition icon only, expandable for full details. Use shadcn/ui Collapsible component. Default collapsed on mobile.

    **RoomGrid (`components/dashboard/room-grid.tsx`):**
    Client component that renders room cards in a responsive grid. For now, renders cards in a simple grid without sorting/drag (sorting added in plan 02-02).
    - Mobile: `grid-cols-2` (2 columns side by side per user decision, NOT single column)
    - Desktop: `grid-cols-2 lg:grid-cols-3` (3 columns when weather side panel leaves enough space)
    - Accept `readings: Map<string, LatestSensorReading>` and `sensorConfig: SensorConfig[]`
    - Map over sensor configs to render a RoomCard for each active sensor that has a reading
    - Pass the corresponding reading data to each RoomCard

    **DarkModeToggle (`components/dashboard/dark-mode-toggle.tsx`):**
    Client component with Sun/Moon icon toggle using next-themes `useTheme()`. Use shadcn/ui Button variant="ghost" size="icon". Place in top-right area of dashboard header. See RESEARCH.md Pattern 4 for implementation.

    **Dashboard page (`app/page.tsx`):**
    Server component that fetches initial data and renders the dashboard. Must:
    - Create server Supabase client via `createClient()` from `lib/supabase/server.ts`
    - Fetch latest sensor readings from the `latest_sensor_readings` view (created in migration 004)
    - Fetch sensor config from `sensor_config` WHERE `unassigned_at IS NULL`
    - Fetch latest weather from the `latest_weather` view
    - Render a minimal header with the project name and DarkModeToggle
    - Render RealtimeProvider wrapping the dashboard content, passing initial data
    - Inside RealtimeProvider: render flex layout with RoomGrid (main area) and WeatherPanel (side panel on desktop, stacked on mobile)
    - Responsive container: `flex flex-col lg:flex-row gap-6 p-4 max-w-7xl mx-auto`

    **Styling guidelines (Claude's discretion, following Linear/Vercel aesthetic):**
    - Minimal and clean: lots of whitespace, subtle borders (border-zinc-200 dark:border-zinc-800)
    - No heavy shadows in dark mode. Light mode: shadow-sm on cards only
    - Typography: use Geist font (loaded in layout.tsx). Temperature readings in font-light or font-normal, not bold
    - Card padding: p-4 to p-6 for breathing room
    - Color restraint: primarily zinc palette, with color only from comfort badges/tints and weather condition icons
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `npm run dev` starts the development server
    3. Visit http://localhost:3000 -- page renders without runtime errors (may show empty state if no Supabase connection)
    4. Verify file structure: `ls components/dashboard/` shows realtime-provider.tsx, room-card.tsx, room-grid.tsx, weather-panel.tsx, dark-mode-toggle.tsx
    5. `grep -r "postgres_changes" components/` confirms Realtime subscription exists
    6. `grep -r "dewPoint\|absoluteHumidity\|classifyComfort" components/` confirms comfort metrics are computed in room-card
    7. `grep -r "weatherConditionFromCode" components/` confirms weather condition derivation in weather-panel
    8. `grep -r "formatDistanceToNow" components/` confirms relative timestamps are used
    9. `grep -r "isSensorStale\|isWeatherStale" components/` confirms staleness detection is integrated
  </verify>
  <done>
    Dashboard page renders with server-fetched initial data. Room cards show temperature (large), humidity, pressure (converted to hPa), dew point, absolute humidity, comfort classification (badge + tint + label), relative timestamp, and conditional battery/staleness warnings. Weather panel shows all FMI fields with derived condition icon, wind direction compass, and precipitation label. Realtime subscriptions update the dashboard live on new data inserts. Layout is responsive (2-col mobile, 3-col desktop with weather side panel). Dark mode is the default theme. The page follows the Linear/Vercel minimal aesthetic.
  </done>
</task>

</tasks>

<verification>
1. The Next.js project builds without errors: `npm run build`
2. All required utility functions exist with correct exports: comfort.ts (dewPoint, absoluteHumidity, classifyComfort), weather.ts (weatherConditionFromCode, windDirectionToCompass, precipitationLabel), staleness.ts (isSensorStale, isWeatherStale, useNow)
3. Database migration 004 enables Realtime publication on sensor_readings, weather_observations, and sensor_config
4. Database migration 004 creates latest_sensor_readings and latest_weather views
5. Dashboard page fetches from Supabase views via server component and passes data to Realtime-subscribed client components
6. Room cards display all required data: temperature, humidity, pressure (hPa), dew point, absolute humidity, comfort class (all three: badge + tint + label), relative timestamp, conditional staleness warning, conditional battery warning
7. Weather panel displays all FMI fields with condition derivation, wind compass, precipitation label
8. Layout is responsive: 2-col card grid on mobile, 3-col with side panel on desktop
9. Dark mode is default on first visit
</verification>

<success_criteria>
- Dashboard page renders and displays room cards for every active sensor with all readings and comfort metrics
- Weather panel displays all FMI observation fields with derived condition
- Realtime subscriptions are established for sensor_readings and weather_observations
- Relative timestamps auto-refresh every 30 seconds
- Stale sensors are visually dimmed with warning icon
- Low battery shows warning icon only when below 2.4V threshold
- Dark mode is default, responsive layout works on mobile (2-col) and desktop (3-col + side panel)
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-live-dashboard/02-01-SUMMARY.md`
</output>
