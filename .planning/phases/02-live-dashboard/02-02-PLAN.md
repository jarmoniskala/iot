---
phase: 02-live-dashboard
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - components/dashboard/room-grid.tsx
  - components/dashboard/room-card.tsx
  - components/dashboard/weather-panel.tsx
  - components/dashboard/sort-controls.tsx
  - components/dashboard/edit-room-dialog.tsx
  - app/page.tsx
autonomous: true
requirements:
  - LIVE-06
  - LIVE-07

must_haves:
  truths:
    - "User can reorder room cards by dragging and dropping, and the custom order persists across browser sessions"
    - "User can sort room cards by alphabetical order or by temperature"
    - "User can edit a room's display name and icon from the dashboard"
    - "Outdoor weather panel collapses on mobile showing only temperature and condition icon, expandable for full details"
    - "User can toggle between dark and light mode with a visible button"
    - "Sort controls are accessible via a subtle icon, not a prominent top bar"
  artifacts:
    - path: "components/dashboard/sort-controls.tsx"
      provides: "Sort mode selector with alphabetical, temperature, and custom drag options"
      contains: "SortMode"
    - path: "components/dashboard/room-grid.tsx"
      provides: "Sortable grid with @dnd-kit drag-and-drop reordering and sort mode switching"
      contains: "DndContext"
    - path: "components/dashboard/edit-room-dialog.tsx"
      provides: "Inline editing dialog for room display name and icon"
      contains: "sensor_config"
  key_links:
    - from: "components/dashboard/room-grid.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext wraps room cards for drag reorder"
      pattern: "SortableContext.*rectSortingStrategy"
    - from: "components/dashboard/room-grid.tsx"
      to: "localStorage"
      via: "Custom card order persisted to and loaded from localStorage"
      pattern: "localStorage.*card-order"
    - from: "components/dashboard/edit-room-dialog.tsx"
      to: "lib/supabase/client.ts"
      via: "Updates sensor_config table with new display_name via Supabase client"
      pattern: "supabase.*sensor_config.*update"
---

<objective>
Add card sorting (alphabetical, by temperature, custom drag-to-reorder), room name/icon editing, mobile-collapsible weather panel, and dark mode toggle to the live dashboard.

Purpose: These features complete the dashboard's interactivity and mobile experience, fulfilling the user's locked decisions about card ordering, editability, and mobile layout.

Output: A fully interactive dashboard with sortable/draggable room cards, editable room labels, collapsible mobile weather, and visible dark mode toggle.
</objective>

<execution_context>
@/Users/jarmoniskala/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jarmoniskala/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-live-dashboard/02-CONTEXT.md
@.planning/phases/02-live-dashboard/02-RESEARCH.md
@.planning/phases/02-live-dashboard/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sortable card grid with drag-to-reorder and sort controls</name>
  <files>
    components/dashboard/room-grid.tsx
    components/dashboard/sort-controls.tsx
    components/dashboard/room-card.tsx
  </files>
  <action>
    **SortControls (`components/dashboard/sort-controls.tsx`):**
    Create a client component that provides the sort mode selector. Per user's locked decision: "Sort controls via subtle icon (not prominent top bar)."
    - Render a small icon button (lucide-react ArrowUpDown or ListFilter icon) that opens a dropdown/popover
    - Three options: "Alphabetical" (sorts by room display_name), "By Temperature" (sorts by current temperature, highest first), "Custom" (enables drag reorder)
    - Use shadcn/ui Button (variant="ghost", size="icon") for the trigger
    - Use a simple dropdown menu or popover for options (shadcn/ui DropdownMenu if available, or a simple state-controlled div with absolute positioning)
    - Emit `onSortChange(mode: SortMode)` callback to parent
    - Highlight the currently active sort mode

    **RoomGrid upgrade (`components/dashboard/room-grid.tsx`):**
    Upgrade the basic grid from plan 02-01 to support sorting and drag-to-reorder. See RESEARCH.md Pattern 5 for @dnd-kit implementation reference.

    Must implement:
    - Accept `sortMode: SortMode` state from parent (or manage internally with useState)
    - Accept `readings: Map<string, LatestSensorReading>` and `sensorConfig: SensorConfig[]`
    - **Alphabetical mode:** Sort cards by display_name (or room_name) alphabetically
    - **Temperature mode:** Sort cards by current temperature descending (hottest first). Cards with no reading sort to the end.
    - **Custom mode:** Enable @dnd-kit drag-and-drop. Use DndContext, SortableContext with rectSortingStrategy, useSortable hook, PointerSensor with activationConstraint distance: 8 (prevent accidental drags)
    - **localStorage persistence (custom mode only):** On drag end, save the new card order (array of mac_addresses) to `localStorage.setItem('card-order', JSON.stringify(order))`. On mount, check if sort mode is 'custom' and load saved order from localStorage.
    - **SSR safety:** Do NOT access localStorage during initial render. Initialize card order with a default (alphabetical). Load from localStorage in useEffect only. This prevents hydration mismatch (see RESEARCH.md Pitfall 6).
    - **SortableCard wrapper:** Each card in custom mode gets wrapped in a div with useSortable() providing ref, transform, transition, attributes, listeners. Apply CSS transform via `CSS.Transform.toString(transform)`.
    - In non-custom modes, render cards in a plain grid without DndContext (skip the drag overhead when not needed).
    - Grid classes: `grid grid-cols-2 gap-4 lg:grid-cols-3` (per user decision: 2-col on mobile, 3-col on desktop)

    **RoomCard minor update (`components/dashboard/room-card.tsx`):**
    Add a small edit button (lucide-react Pencil or Settings icon) that appears on hover or as a subtle icon in the card corner. When clicked, it opens the edit dialog (implemented in Task 2). For now, add the button with an `onEdit` callback prop. Keep it very subtle (opacity-0 group-hover:opacity-100 transition) to not clutter the minimal design.

    **Integration:** Render SortControls in the dashboard header area (near the DarkModeToggle). Pass sort mode state down to RoomGrid.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `grep -r "DndContext" components/dashboard/room-grid.tsx` confirms drag-and-drop is set up
    3. `grep -r "SortableContext" components/dashboard/room-grid.tsx` confirms sortable grid
    4. `grep -r "localStorage.*card-order" components/dashboard/room-grid.tsx` confirms persistence
    5. `grep -r "SortMode" components/dashboard/sort-controls.tsx` confirms sort mode options
    6. `grep -r "useEffect" components/dashboard/room-grid.tsx` confirms localStorage is loaded in effect (SSR safe)
  </verify>
  <done>
    Room cards can be sorted alphabetically, by temperature, or by custom drag-to-reorder. Dragging is smooth with the 8px activation distance. Custom order persists to localStorage and survives page refresh without hydration mismatch. Sort controls are a subtle icon button with dropdown, not a prominent bar. Each card has a subtle edit button visible on hover.
  </done>
</task>

<task type="auto">
  <name>Task 2: Room editing, mobile collapsible weather, and dark mode toggle integration</name>
  <files>
    components/dashboard/edit-room-dialog.tsx
    components/dashboard/weather-panel.tsx
    components/dashboard/dark-mode-toggle.tsx
    app/page.tsx
  </files>
  <action>
    **EditRoomDialog (`components/dashboard/edit-room-dialog.tsx`):**
    Create a client component for editing room display_name and icon. Per user's locked decision: "Room names and icons are user-editable from the dashboard."

    Must implement:
    - Accept `sensor: SensorConfig`, `isOpen: boolean`, `onClose: () => void`, and `onSave: (updated: SensorConfig) => void` props
    - Show a simple dialog/modal (use shadcn/ui Dialog if available, or a popover/sheet) with:
      - Text input for display_name (pre-filled with current value)
      - Icon selector: show available icons (Bed, Baby, Sofa, Monitor, TreePine, Home) as clickable icon buttons, highlight the currently selected one
    - On save: update `sensor_config` table via Supabase client `supabase.from('sensor_config').update({ display_name, room_name }).eq('id', sensor.id)`. The RLS UPDATE policy from migration 004 allows this.
    - Call `onSave` with the updated sensor config so the parent can update local state without waiting for Realtime
    - Show a loading state on the save button during the Supabase call
    - Close dialog on successful save

    NOTE: For icon persistence, the simplest approach is to store the icon name in the `notes` field of sensor_config (since there's no dedicated icon column). Parse it as JSON or use a convention like "icon:Bed". Alternatively, store icon preferences in localStorage keyed by mac_address. Choose whichever is simpler -- localStorage is fine since this is a personal dashboard.

    **WeatherPanel collapsible update (`components/dashboard/weather-panel.tsx`):**
    Modify the weather panel to be collapsible on mobile, per user's locked decision: "Collapsible on mobile -- collapsed shows temperature + condition icon, expandable for full details."

    Must implement:
    - Use shadcn/ui Collapsible component (CollapsibleTrigger + CollapsibleContent)
    - On mobile (below lg breakpoint): default to collapsed. Show only temperature + weather condition icon in the trigger area. The full details (humidity, wind, pressure, precipitation, cloud cover, etc.) are in CollapsibleContent.
    - On desktop (lg and above): always show all details (no collapsible behavior, or always expanded)
    - Use responsive classes or a `useMediaQuery` approach. Simplest: always render with Collapsible but on desktop set `open={true}` and hide the toggle chevron.
    - Collapsed trigger should show a subtle ChevronDown icon that rotates when expanded (ChevronUp or rotate-180 transform)

    **DarkModeToggle final integration (`components/dashboard/dark-mode-toggle.tsx`):**
    Ensure the toggle is properly placed and visible. Per user decision: dark mode by default, toggle to switch. The component was created in plan 02-01. Verify it:
    - Uses `useTheme()` from next-themes
    - Shows Sun icon in dark mode, Moon icon in light mode (with rotation transition per RESEARCH.md Pattern 4)
    - Is positioned in the top-right of the dashboard header
    - Uses shadcn/ui Button variant="ghost" size="icon"
    - Has sr-only text "Toggle theme" for accessibility

    **Dashboard page integration (`app/page.tsx`):**
    Update the page layout to integrate sort controls, edit callbacks, and collapsible weather:
    - Add sort mode state management (lifted from RoomGrid if needed, or pass down)
    - Header row: project title on left, SortControls + DarkModeToggle on right
    - Pass `onEdit` callback through RoomGrid -> RoomCard to open EditRoomDialog
    - Manage EditRoomDialog open/close state and the sensor being edited
    - After a room edit saves, update the local sensorConfig state so the change reflects immediately (don't wait for page refresh)

    If the page.tsx is a server component, the interactive state management needs to live in a client component wrapper. Create a thin `DashboardClient` wrapper if needed, or use the existing RealtimeProvider to hold additional state.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. `ls components/dashboard/edit-room-dialog.tsx` confirms edit dialog exists
    3. `grep -r "Collapsible" components/dashboard/weather-panel.tsx` confirms collapsible is used
    4. `grep -r "sensor_config.*update" components/dashboard/edit-room-dialog.tsx` confirms Supabase update
    5. `grep -r "useTheme" components/dashboard/dark-mode-toggle.tsx` confirms theme toggle works
    6. `npm run dev` starts and the dashboard renders with sort controls and dark mode toggle visible
  </verify>
  <done>
    Room names and icons are editable from the dashboard via a dialog triggered by the card's edit button. Changes persist to Supabase sensor_config table. Weather panel collapses on mobile showing only temperature + condition icon, and expands to show all details. Dark mode toggle is visible in the header and switches between dark and light themes. Sort controls are accessible via a subtle icon in the header.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Card sorting works in all three modes: alphabetical, by temperature, custom drag
3. Custom drag order persists in localStorage and survives page refresh
4. Sort controls are a subtle icon button, not a prominent bar
5. Room edit dialog opens on card edit button click, allows changing name and icon
6. Room edit persists to Supabase sensor_config table
7. Weather panel collapses on mobile (shows temp + icon only) and expands on tap
8. Weather panel is always expanded on desktop
9. Dark mode toggle is visible and functional
10. No hydration mismatch warnings in browser console
</verification>

<success_criteria>
- Room cards can be sorted alphabetically, by temperature, or by custom drag-to-reorder
- Custom drag order persists to localStorage across sessions
- Room display name and icon can be edited from the dashboard
- Weather panel is collapsible on mobile (collapsed by default), always expanded on desktop
- Dark mode toggle switches themes correctly
- All features work without breaking existing room card display, comfort metrics, or Realtime subscriptions from plan 02-01
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-live-dashboard/02-02-SUMMARY.md`
</output>
